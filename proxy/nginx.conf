worker_processes  1;
events { worker_connections 1024; }

http {
  map $http_x_api_key $access_api_key {
    default $http_x_api_key;
    "" "-";
  }

  map $http_x_forwarded_for $access_forwarded_for {
    default $http_x_forwarded_for;
    "" "-";
  }

  log_format monitoring escape=json
    "{"
      "\"time\":\"$time_iso8601\","
      "\"remote_addr\":\"$remote_addr\","
      "\"forwarded_for\":\"$access_forwarded_for\","
      "\"request_method\":\"$request_method\","
      "\"request_uri\":\"$request_uri\","
      "\"status\":$status,"
      "\"request_time\":$request_time,"
      "\"body_bytes_sent\":$body_bytes_sent,"
      "\"bytes_sent\":$bytes_sent,"
      "\"http_referer\":\"$http_referer\","
      "\"user_agent\":\"$http_user_agent\","
      "\"api_key\":\"$access_api_key\","
      "\"upstream_addr\":\"$upstream_addr\","
      "\"upstream_status\":\"$upstream_status\","
      "\"upstream_response_time\":\"$upstream_response_time\""
    "}";

  access_log /var/log/nginx/access.log monitoring;

  upstream dashboard_auth {
    server aihub_dashboard:8090;
    keepalive 16;
  }

  server {
    listen 80;

    error_page 401 = @auth_error;
    error_page 403 = @auth_error;

    location = /__auth {
      internal;
      proxy_pass http://dashboard_auth/api/auth/verify;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
      proxy_set_header X-API-Key $http_x_api_key;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host aihub_dashboard;
    }

    location @auth_error {
      add_header Content-Type application/json always;
      return 401 '{"error":"Invalid or missing API key"}';
    }

    # Route to LM Studio
    location /lmstudio/ {
      auth_request /__auth;
      proxy_pass http://host.docker.internal:1234/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Route to Ollama
    location /ollama/ {
      auth_request /__auth;
      proxy_pass http://host.docker.internal:11434/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_read_timeout 300s;
      proxy_send_timeout 300s;
    }

    location /kokoro/ {
      auth_request /__auth;
      proxy_pass http://host.docker.internal:8880/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      client_max_body_size 50m;
    }

    location /openwebui/ {
      auth_request /__auth;
      proxy_pass http://host.docker.internal:3000/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /stt/ {
      auth_request /__auth;
      proxy_pass http://host.docker.internal:10400/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      client_max_body_size 200m;
    }

    location /dashboard/ {
      proxy_pass http://host.docker.internal:8090/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
  }
}
