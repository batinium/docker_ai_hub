env OPENROUTER_API_KEY;
env GATEWAY_API_KEYS;
env lmstudio_host;

worker_processes  1;
events { worker_connections 1024; }

http {
  resolver 127.0.0.11 8.8.8.8 valid=30s ipv6=off;
  map $http_x_api_key $access_api_key {
    default $http_x_api_key;
    "" "-";
  }

  map $http_x_forwarded_for $access_forwarded_for {
    default $http_x_forwarded_for;
    "" "-";
  }

  map "${GATEWAY_API_KEYS}" $gateway_key_1 {
    default "";
    "~^\\s*([^,]+)" $1;
  }

  map "${GATEWAY_API_KEYS}" $gateway_key_2 {
    default "";
    "~^[^,]+,\\s*([^,]+)" $1;
  }

  map "${GATEWAY_API_KEYS}" $gateway_key_3 {
    default "";
    "~^[^,]+,\\s*[^,]+,\\s*([^,]+)" $1;
  }

  map "${GATEWAY_API_KEYS}" $gateway_key_4 {
    default "";
    "~^[^,]+,\\s*[^,]+,\\s*[^,]+,\\s*([^,]+)" $1;
  }

  map "${LMSTUDIO_HOST}" $lmstudio_host {
    default "${LMSTUDIO_HOST}";
    "" "host.docker.internal";
  }

  log_format monitoring escape=json
    "{"
      "\"time\":\"$time_iso8601\","
      "\"remote_addr\":\"$remote_addr\","
      "\"forwarded_for\":\"$access_forwarded_for\","
      "\"request_method\":\"$request_method\","
      "\"request_uri\":\"$request_uri\","
      "\"status\":$status,"
      "\"request_time\":$request_time,"
      "\"body_bytes_sent\":$body_bytes_sent,"
      "\"bytes_sent\":$bytes_sent,"
      "\"http_referer\":\"$http_referer\","
      "\"user_agent\":\"$http_user_agent\","
      "\"api_key\":\"$access_api_key\","
      "\"upstream_addr\":\"$upstream_addr\","
      "\"upstream_status\":\"$upstream_status\","
      "\"upstream_response_time\":\"$upstream_response_time\""
    "}";

  access_log /var/log/nginx/access.log monitoring;

  server {
    listen 80;

    error_page 401 = @auth_error;

    location @auth_error {
      add_header Content-Type application/json always;
      return 401 '{"error":"Invalid or missing API key"}';
    }

    # Route to LM Studio
    location /lmstudio/ {
      set $auth_ok 0;
      if ($gateway_key_1 = "") {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_1) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_2) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_3) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_4) {
        set $auth_ok 1;
      }
      if ($auth_ok = 0) {
        return 401;
      }
      rewrite ^/lmstudio/(.*) /$1 break;
      proxy_pass http://$lmstudio_host:1234;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_connect_timeout 10s;
      proxy_send_timeout 120s;
      proxy_read_timeout 120s;
    }

    location /kokoro/ {
      set $auth_ok 0;
      if ($gateway_key_1 = "") {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_1) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_2) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_3) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_4) {
        set $auth_ok 1;
      }
      if ($auth_ok = 0) {
        return 401;
      }
      proxy_pass http://host.docker.internal:8880/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      client_max_body_size 50m;
    }

    # OpenRouter - requires internet connection
    location /openrouter/ {
      set $auth_ok 0;
      if ($gateway_key_1 = "") {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_1) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_2) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_3) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_4) {
        set $auth_ok 1;
      }
      if ($auth_ok = 0) {
        return 401;
      }
      set $openrouter_backend "openrouter.ai";
      proxy_pass https://$openrouter_backend/api/;
      proxy_http_version 1.1;
      proxy_ssl_server_name on;
      proxy_set_header Host openrouter.ai;
      proxy_set_header Connection "";
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Authorization "Bearer ${OPENROUTER_API_KEY}";
      proxy_read_timeout 300s;
      proxy_send_timeout 300s;
    }

    location /stt/ {
      set $auth_ok 0;
      if ($gateway_key_1 = "") {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_1) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_2) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_3) {
        set $auth_ok 1;
      }
      if ($http_x_api_key = $gateway_key_4) {
        set $auth_ok 1;
      }
      if ($auth_ok = 0) {
        return 401;
      }
      proxy_pass http://host.docker.internal:10400/;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      client_max_body_size 200m;
      proxy_connect_timeout 10s;
      proxy_send_timeout 300s;
      proxy_read_timeout 300s;
    }

  }
}
